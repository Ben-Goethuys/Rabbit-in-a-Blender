{#
/*********
FIELD LEVEL check:
WITHIN_VISIT_DATES - find events that occur one week before the corresponding visit_start_date or one week after the corresponding visit_end_date

Parameters used in this template:
cdmDatabaseSchema = @cdmDatabaseSchema
cdmTableName = @cdmTableName
cdmFieldName = @cdmFieldName
{@cohort & '@runForCohort' == 'Yes'}?{
cohortDefinitionId = @cohortDefinitionId
cohortDatabaseSchema = @cohortDatabaseSchema
}
**********/
#}

SELECT num_violated_rows, 
       CASE WHEN denominator.num_rows = 0 THEN 0 ELSE 1.0*num_violated_rows/denominator.num_rows END  AS pct_violated_rows, 
       denominator.num_rows as num_denominator_rows
FROM
(
	SELECT COUNT(violated_rows.violating_field) AS num_violated_rows
	FROM
	(
		/*violatedRowsBegin*/
		SELECT '{{cdmTableName}}.{{cdmFieldName}}' AS violating_field, cdmTable.*
          FROM {{project_id}}.{{dataset_id_omop}}.{{cdmTableName}} cdmTable
          {% if cohort and runForCohort == 'Yes' -%}
    	  JOIN {{project_id}}.{{dataset_id_omop}}.cohort c 
    	    ON cdmTable.person_id = c.subject_id
    	   AND c.cohort_definition_id = {{cohortDefinitionId}}
    	  {%- endif %}
          JOIN {{project_id}}.{{dataset_id_omop}}.visit_occurrence vo
            ON cdmTable.visit_occurrence_id = vo.visit_occurrence_id
         WHERE cdmTable.{{cdmFieldName}} < date_add(vo.visit_start_date, interval -7 day)
            OR cdmTable.{{cdmFieldName}} > date_add(vo.visit_end_date, interval 7 day) 
		/*violatedRowsEnd*/
	) violated_rows
) violated_row_count,
(
	SELECT COUNT(*) AS num_rows
	FROM {{project_id}}.{{dataset_id_omop}}.{{cdmTableName}} cdmTable
	{% if cohort and runForCohort == 'Yes' -%}
    JOIN {{project_id}}.{{dataset_id_omop}}.cohort c 
      ON cdmTable.person_id = c.subject_id
     AND c.cohort_definition_id = {{cohortDefinitionId}}
    {%- endif %}
    JOIN {{project_id}}.{{dataset_id_omop}}.visit_occurrence vo
      ON cdmTable.visit_occurrence_id = vo.visit_occurrence_id
) denominator
;